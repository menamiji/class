# Class 하위시스템 개발문서 (개발자용)

## 0. 문서 목적과 범위
- 본 문서는 교과 수업용 Class 웹앱의 개발 명세서입니다.
- 대상 독자: 프론트엔드/백엔드 개발자, DevOps, 테스트 엔지니어
- 참고 문서: `ubuntu_server.md`, `20501_class/summary.md`, `20501_class/deployment-guide.md`, `20501_class/troubleshooting.md`
- 목표: 학생 실습파일 배포/제출, 관리자용 과목/콘텐츠/권한 관리, 향후 AI 분석(ollama) 연계 기반을 구축

## 1. 시스템 개요
- 사용자 플로우: 로그인 → 과목 선택 → 실습파일 다운로드 → 결과 파일 제출 → 제출내역 확인 →(향후) AI 분석 결과 확인
- 전체 아키텍처(제안)
```
사용자(브라우저)
  ↓ HTTPS(Cloudflare)
nginx(정적: Flutter Web, 리버스프록시 /class/api/)
  ↓
file-service(제안, FastAPI)
  ↓
NAS NFS(mount): 제출/콘텐츠 파일 보관
  ↓
Supabase(Postgres, Auth, 메타데이터)
```
- 현황: 프론트엔드 정적 배포(nginx)는 운영 중. 다중 파일 업로드/서버 저장(NAS)/메타데이터(Supabase) 관리는 백엔드(file-service) 추가가 필요.
## 2. 기능 요구사항

### 2.1 공통
- **인증**: Google OAuth(Supabase Auth) 사용. `@pocheonil.hs.kr` 도메인만 허용(관리자 설정으로 추가 도메인 화이트리스트 확장 가능).
- **권한**: `student`, `teacher`, `admin` 롤. 페이지/메뉴 가드, API Role Check.
- **로깅**: nginx 액세스, file-service 앱로그(JSON), 감사 로그(제출/삭제/다운로드 이벤트).
- **감사 대상 이벤트**: 로그인/로그아웃, 실습파일 업로드/삭제, 관리자 파일 등록/삭제, 설정 변경.

### 2.2 학생 기능
- 실습파일 다운로드: 관리자 등록 파일 목록 자동 표시, 파일 클릭 시 다운로드.
- 결과 파일 제출: 다중 파일 업로드, 드래그앤드롭, 진행률 표시, 재시도.
- 디렉터리 정책: `YYYYMMDD/학번/파일` 구조(날짜는 항상 오늘 기준). 학번은 로그인 이메일 로컬파트(예: `2510401`).
- 파일명 충돌: 동일 경로 존재 시 덮어쓰기(이전 파일은 백엔드에서 버전 기록만 메타로 유지 가능 옵션).
- 제출 내역 확인: 날짜/파일별 목록, 최신 업로드 타임스탬프 표시.

### 2.3 관리자 기능
- 과목 관리: 현재 1과목 운영, 추후 다과목 확장 예정(등록/사용여부/정렬).
- 콘텐츠 관리(정보처리와 관리): 카테고리-항목-파일 다중 업로드/삭제, 프론트에 즉시 반영.
- 회원권한 관리: 로그인 허용 도메인/특정 계정 화이트리스트, 롤 부여.
- 파일 관리: 업로드된 파일 삭제 시 스토리지에서도 삭제.

### 2.4 향후 기능(로드맵)
- Ollama 분석 파이프라인 연동(API 호출, 비동기 큐) — 향후 검토 후 설계/개발.
- 알림(이메일/슬랙) 및 대시보드.
- 외부 접근 사용자 가이드 자동 생성.
## 3. 화면/UX 요구사항

### 3.1 전역 레이아웃
- 상단: 바로가기 메뉴(학교/과목/관리자/로그아웃), 사용자 프로필 드롭다운.
- 본문: 상위 메뉴(실습 파일 다운로드, 실습 결과 파일 제출), 하위 메뉴 없음.
- 반응형: 1280px 이상 데스크탑 기준, 모바일은 360px 이상 대응(하단 탭으로 축소).

### 3.2 로그인/액세스 제어
- 구글 로그인 버튼. 인증 성공 시 롤에 따라 메뉴 노출.
- `admin` 롤일 경우 상단에 `관리자` 노출.

### 3.3 실습 파일 다운로드
- 카테고리 아코디언(스프레드시트/워드/프리젠테이션/공유/DB 등).
- 각 항목에 파일명(확장자 포함) 및 크기/업로드일 표기.
- 다운로드 클릭 시 진행 상태/실패 재시도 UI.

### 3.4 실습 결과 파일 제출
- 날짜 정책: 항상 오늘 날짜로 `YYYYMMDD` 디렉터리 자동 생성(추후 설정으로 변경 가능).
- 파일 드래그앤드롭/클립보드 붙여넣기 지원.
- 업로드 큐/진행률/실패 재시도/전체 취소.
- 완료 후 목록 갱신 및 토스트 알림.

### 3.5 관리자 화면
- 과목/콘텐츠/권한 3개 탭.
- 콘텐츠 탭: 카테고리/항목 트리, 다중 업로드, 서버 저장 경로 미리보기, 삭제 버튼.
## 4. 데이터 모델(초안)

### 4.1 Supabase(Postgres)
- 테이블: `subjects`
  - `id` UUID PK
  - `name` text
  - `is_enabled` boolean
  - `order_index` int
- 테이블: `subject_contents`
  - `id` UUID PK
  - `subject_id` FK → subjects
  - `category` text  # 예: 스프레드시트/워드/프레젠테이션/공유/DB
  - `item` text      # 예: 기본시트 작성
  - `files` jsonb[]  # 파일 메타 배열 [{name,size,ext,path,hash,uploaded_at}]
- 테이블: `submissions`
  - `id` UUID PK
  - `date_key` text  # YYYYMMDD
  - `student_no` text # 2510401
  - `files` jsonb[]  # 제출 파일 목록
  - `created_at` timestamptz default now()
- 테이블: `roles`
  - `user_id` uuid (auth.users)
  - `role` text check in ('student','teacher','admin')

### 4.2 파일시스템(NAS/NFS)
- 콘텐츠 저장: `/mnt/nas-class/content/<subject>/<category>/<item>/<filename>`
- 제출 저장: `/mnt/nas-class/submissions/<date>/<student_no>/<filename>`
- 접근 권한: 컨테이너에서 `docker` 그룹 읽기/쓰기, 디렉터리 775, 파일 664 권장.
## 5. API 설계(초안)
- 베이스 경로: `/class/api`
- 인증: Supabase JWT 또는 세션 쿠키(리버스프록시에서 헤더 전달)

### 5.1 인증/권한
- GET `/auth/me` → 현재 사용자 정보/롤
- POST `/auth/logout` → 로그아웃

### 5.2 과목/콘텐츠
- GET `/subjects` → 과목 목록
- PATCH `/subjects/:id` → 순서/활성화 수정 (admin)
- GET `/subjects/:id/contents` → 카테고리/항목/파일 리스트
- POST `/subjects/:id/contents/files` (admin, multipart) → 다중 업로드
- DELETE `/subjects/:id/contents/files` (admin, body: [{path}]) → 다중 삭제

### 5.3 제출
- GET `/submissions?date=YYYYMMDD&student_no=...` → 제출 내역 조회
- POST `/submissions/upload` (multipart) → 매개변수: `date_key`, 파일들. 서버가 `student_no`를 토큰에서 추출.
- DELETE `/submissions/file` → body: {date_key, filename}

### 5.4 파일 전송 정책
- 파일 크기 제한: 없음(무제한). 대용량 업로드 시 프록시/백엔드 타임아웃만 고려.
- 허용 확장자: 제한 없음(무제한). 콘텐츠 보안은 운영 정책으로 별도 관리.
- 전송 안정성: 청크 업로드/재시도 전략(프론트), 백엔드 스트리밍 처리 권장.
- 보안 스캔: 바이러스 스캔(향후, clamav 등) 옵션으로 도입 검토.

### 5.5 응답 포맷(예)
```json
{
  "ok": true,
  "data": { ... },
  "error": null
}
```
- 에러 시: HTTP 4xx/5xx + `{ ok:false, error:{code,message} }`
## 6. 보안/권한
- 도메인 제한: `@pocheonil.hs.kr` 기본, 관리자 화이트리스트 추가 지원.
- JWT 검증: 리버스프록시에서 Authorization 전달, 백엔드 미들웨어 검증.
- RBAC: 엔드포인트별 롤 매핑 테이블 유지.
- 입력 검증: 파일명 화이트리스트, 경로 탐색(`..`) 차단, MIME 검증.
- 저장소 권한: 디렉터리 775, 파일 664, 소유자 `menamiji:docker`.
- 비밀관리: API 키/토큰은 `.env`로, Git에 커밋 금지.
- 초기 관리자: `menamiji@pocheonil.hs.kr` 1명으로 시작(추후 UI로 추가/변경).

## 7. 배포/운영
- 프론트: Flutter Web 정적 빌드 → `~/docker-services/data/apps/class/`
- 백엔드(제안): FastAPI 컨테이너 `file-service` 추가, `/class/api` 경로로 프록시.
- nginx 설정(요지): `location /class/` 정적, `location /class/api/` 프록시.
- 모니터링: `docker compose logs`, `docker stats`, Cloudflare 터널 로그.
- 백업: `backup-class.sh` 참고, 제출/콘텐츠 디렉터리와 메타데이터 덤프.

## 8. 파일 저장 규칙
- 콘텐츠: `/mnt/nas-class/content/<subject>/<category>/<item>/<filename>`
- 제출: `/mnt/nas-class/submissions/<date>/<student_no>/<filename>`
- 덮어쓰기: 동일 파일명 업로드 시 교체, 메타 히스토리만 유지(옵션).
- 파일 삭제: 관리자 삭제 시 실제 파일 제거 + 메타 삭제, 감사 로그 기록.

## 9. 테스트 시나리오(샘플)
- 인증: `@pocheonil.hs.kr` 이외 로그인 차단 확인.
- 다운로드: 카테고리별 파일 노출/다운로드 성공.
- 업로드: 5개 파일 동시 업로드, 진행률/재시도 동작.
- 경로생성: `YYYYMMDD/학번` 자동 생성 검증.
- 덮어쓰기: 동일 파일 재업로드 시 교체 확인.
- 권한: `admin`만 콘텐츠 업로드/삭제 가능.

## 10. 오픈 이슈/결정 필요
- 백엔드 구현 방식: NAS 직접 저장 + Supabase는 메타데이터/인증 전용(확정).
- 파일 메타 버전관리 필요 여부.
- 업로드 크기/확장자 정책 상세화.
- Ollama 분석 연계 시 큐/비동기 처리 방식(Redis/Celery or Supabase functions).
- 외부 사용자 접근 정책(교내/교외) 세분화.

---
문서 버전: 0.1 (2025-09-08 초안)
담당: menamiji
## 5A. FastAPI file-service 설계 상세

### 5A.1 인증/헤더
- Authorization: `Bearer <supabase_jwt>` (필수)
- 서버는 JWT에서 이메일을 추출하여 `student_no = split('@')[0]`로 사용
- 관리자는 Supabase `roles` 테이블에서 조회(`admin` 롤)

### 5A.2 엔드포인트
- GET `/healthz`
  - 응답: `{ ok:true, data:{ status:"ok" } }`
- GET `/subjects/{subject_id}/contents`
  - 쿼리: `category?`, `item?`
  - 동작: Supabase 메타 조회 또는 NAS 스캔 후 메타 반환
- POST `/subjects/{subject_id}/contents/files` (admin, multipart)
  - 필드: `category`, `item`, `files[]`
  - 저장: `${CONTENT_DIR}/{subject}/{category}/{item}/filename`
- DELETE `/subjects/{subject_id}/contents/files` (admin)
  - 바디: `{ paths: ["<subject>/<category>/<item>/<filename>", ...] }`
- GET `/submissions?date=YYYYMMDD`
  - 동작: (학생) 본인 것만, (admin) 전체 조회
- POST `/submissions/upload` (multipart)
  - 필드: `date_key`(선택, 기본 오늘), `files[]`
  - 저장: `${SUBMISSIONS_DIR}/{YYYYMMDD}/{student_no}/filename`
- DELETE `/submissions/file`
  - 바디: `{ date_key, filename }`

### 5A.3 에러 코드 규격
- 400 `INVALID_PARAM`, `PATH_TRAVERSAL_BLOCKED`
- 403 `PERMISSION_DENIED`
- 404 `NOT_FOUND`
- 413 `FILE_TOO_LARGE` (프록시/OS 제한 시)
- 500 `INTERNAL`
- 504 `TIMEOUT`

### 5A.4 예제 응답
```json
{ "ok": true, "data": { "files": [{"name":"데이터입력.xlsx","size":102400,"path":"정보처리와관리/스프레드시트/기본시트/데이터입력.xlsx","uploaded_at":"2025-09-08T09:10:11Z"}] }, "error": null }
```
## 7A. nginx 설정 예시(`/class/api/`)

```nginx
# 정적
location /class/ {
    root /usr/share/nginx/html;  # 배포 경로와 일치
    try_files $uri $uri/ /class/index.html;
    gzip on;
    gzip_types text/plain text/css application/javascript application/json;
}

# API
location /class/api/ {
    client_max_body_size 0;               # 업로드 무제한에 준함
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_pass http://file-service:8000/;
}
```
## 7B. Docker Compose 스니펫(요지)

```yaml
services:
  file-service:
    image: ghcr.io/your-org/file-service:latest  # 또는 build: ./services/file-service
    env_file:
      - ./services/file-service/.env
    volumes:
      - /mnt/nas-class:/mnt/nas-class:rw
    networks:
      - app-net
    restart: unless-stopped

  nginx:
    image: nginx:1.29
    volumes:
      - ./services/nginx/conf/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./data/apps/class:/usr/share/nginx/html/class:ro
    ports:
      - "80:80"
    depends_on:
      - file-service
    networks:
      - app-net
    restart: unless-stopped

networks:
  app-net:
    driver: bridge
```
## 4A. Supabase 스키마 SQL 초안 + RLS

```sql
-- 테이블: subjects
create table if not exists public.subjects (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  is_enabled boolean not null default true,
  order_index int not null default 0
);

-- 테이블: subject_contents
create table if not exists public.subject_contents (
  id uuid primary key default gen_random_uuid(),
  subject_id uuid not null references public.subjects(id) on delete cascade,
  category text not null,
  item text not null,
  files jsonb not null default '[]'::jsonb
);
create index if not exists idx_subject_contents_subject on public.subject_contents(subject_id);

-- 테이블: submissions
create table if not exists public.submissions (
  id uuid primary key default gen_random_uuid(),
  date_key text not null,
  student_no text not null,
  files jsonb not null default '[]'::jsonb,
  created_at timestamptz not null default now()
);
create index if not exists idx_submissions_student_date on public.submissions(student_no, date_key);

-- 테이블: roles
create table if not exists public.roles (
  user_id uuid not null references auth.users(id) on delete cascade,
  role text not null check (role in ('student','teacher','admin')),
  primary key(user_id)
);

-- RLS 활성화
alter table public.subjects enable row level security;
alter table public.subject_contents enable row level security;
alter table public.submissions enable row level security;
alter table public.roles enable row level security;

-- 정책: submissions (학생은 본인 것만)
create policy if not exists select_own_submissions on public.submissions
  for select using (auth.jwt() ->> 'email' ilike (student_no || '@%'));
create policy if not exists insert_own_submissions on public.submissions
  for insert with check (auth.jwt() ->> 'email' ilike (student_no || '@%'));
create policy if not exists delete_own_submissions on public.submissions
  for delete using (auth.jwt() ->> 'email' ilike (student_no || '@%'));

-- 정책: admin은 모두 접근
create policy if not exists admin_all_subjects on public.subjects
  for all using (exists(select 1 from public.roles r where r.user_id = auth.uid() and r.role='admin'))
  with check (exists(select 1 from public.roles r where r.user_id = auth.uid() and r.role='admin'));
create policy if not exists admin_all_subject_contents on public.subject_contents
  for all using (exists(select 1 from public.roles r where r.user_id = auth.uid() and r.role='admin'))
  with check (exists(select 1 from public.roles r where r.user_id = auth.uid() and r.role='admin'));
create policy if not exists admin_all_submissions on public.submissions
  for all using (exists(select 1 from public.roles r where r.user_id = auth.uid() and r.role='admin'))
  with check (exists(select 1 from public.roles r where r.user_id = auth.uid() and r.role='admin'));

-- 초기 관리자 시드(수동): 이메일로 auth.users 조회 후 roles에 insert
-- insert into public.roles(user_id, role) values ('<auth_users_uuid>','admin');
```

## 11. 운영 변경 이력 및 복구 가이드 (2025-09-08)

### 11.1 적용 변경 요약
- nginx: `/class/api/` 프록시 추가, 접두사 제거(rewrite), `proxy_pass http://file-service:8000;`
- Docker 네트워크: nginx ↔ file-service 동일 네트워크 연결(영구화: `docker-compose.override.yml`)
- file-service: FastAPI 최소 엔드포인트 구현(health/upload/list/delete), `python-multipart` 설치
- cloudflared: 터널 기동 및 설정, 업로드 530 대응(`disableChunkedEncoding: true`), 외부 헬스/업로드/삭제 확인
- NAS: 테스트 잔여물 정리 및 권한 보정(디렉터리 775, 파일 664, 소유자 `menamiji:docker`)
- Supabase: `subjects/subject_contents/submissions/roles` 테이블 생성, RLS 정책 적용, `admin` 롤 부여

### 11.2 주요 파일 위치
- nginx 설정: `~/docker-services/services/nginx/conf/default.conf`
- file-service 앱: `~/docker-services/services/file-service/app/main.py`
- file-service Dockerfile: `~/docker-services/services/file-service/Dockerfile`
- docker-compose override: `~/docker-services/docker-compose.override.yml`
- cloudflared 설정: `~/docker-services/services/cloudflared/config.yml`
- Supabase 스키마/정책: Supabase Studio(SQL Editor)에 저장됨

### 11.3 표준 재기동/검증 명령
```bash
# 재기동
cd ~/docker-services
docker compose up -d --build nginx file-service cloudflared

# 내부 헬스
docker compose exec -T nginx nginx -t && docker compose restart nginx
curl -i http://127.0.0.1/class/api/healthz | head -10

# 외부 헬스
curl -i "https://info.pocheonil.hs.kr/class/api/healthz?t=$(date +%s)" | head -10
```

### 11.4 흔한 장애와 복구 절차
- 증상: `/class/api/healthz` 502
  - 원인: nginx→file-service 네임해결 실패
  - 조치:
    ```bash
    # nginx를 file-service와 동일 네트워크에 연결(즉시)
    docker network connect docker-services_default $(docker compose ps -q nginx) || true
    docker compose exec -T nginx sh -lc 'apk add --no-cache curl >/dev/null 2>&1 || true; curl -sS -i http://file-service:8000/healthz | head -10'
    ```
- 증상: 외부 업로드 530
  - 원인: Cloudflare 터널이 멀티파트 청크를 차단/변환
  - 조치: cloudflared 설정 유지
    ```yaml
    # services/cloudflared/config.yml
    ingress:
      - hostname: info.pocheonil.hs.kr
        service: http://nginx:80
        originRequest:
          disableChunkedEncoding: true
          http2Origin: false
          connectTimeout: 30s
          readTimeout: 600s
          writeTimeout: 600s
      - service: http_status:404
    ```
    ```bash
    docker compose up -d cloudflared
    ```
- 증상: 업로드 415/400
  - 원인: `python-multipart` 미설치 또는 프록시 접두사 미제거
  - 조치: Dockerfile에 `python-multipart` 포함, nginx rewrite 확인

### 11.5 원복(롤백) 방법
- nginx 설정 원복:
  - 컨테이너 내 백업: `/etc/nginx/conf.d/default.conf.bak` (있을 경우)
  - 또는 `~/docker-services/services/nginx/conf/default.conf`를 Git/백업본으로 교체 후 `docker compose restart nginx`
- file-service 원복:
  - `app/main.py`와 `Dockerfile`을 이전 버전으로 되돌린 뒤 `docker compose up -d --build file-service`
- cloudflared 원복:
  - `services/cloudflared/config.yml`의 originRequest 블록 제거/주석 후 `docker compose up -d cloudflared`
- Supabase 원복:
  - 테이블/정책은 SQL 스크립트로 재적용(DDL/RLS). 필요 시 정책 `drop policy ...` 후 재생성

### 11.6 점검 체크리스트(운영)
- [ ] `curl -i http://127.0.0.1/class/api/healthz | head -10` 200
- [ ] `curl -i https://info.pocheonil.hs.kr/class/api/healthz | head -10` 200
- [ ] 소규모 파일 업로드/목록/삭제 200
- [ ] `docker compose logs --since=10m nginx|cloudflared|file-service` 오류 없음
- [ ] NAS 권한 유지(디렉터리 775, 파일 664, 소유자 `menamiji:docker`)

## 12. 재시작 퀵스타트(요약)

### 12.1 필수 환경변수(file-service/.env)
```
APP_ENV=production
APP_PORT=8000
FILE_STORAGE_ROOT=/mnt/nas-class
CONTENT_DIR=/mnt/nas-class/content
SUBMISSIONS_DIR=/mnt/nas-class/submissions
ALLOWED_EMAIL_DOMAIN=pocheonil.hs.kr
ADMIN_EMAILS=menamiji@pocheonil.hs.kr
SUPABASE_URL=https://znocjtfrtxwulyngzqfy.supabase.co
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>
SUPABASE_JWT_SECRET=<Settings → API → Legacy JWT secret>
SUPABASE_JWT_JWKS_URL=https://znocjtfrtxwulyngzqfy.supabase.co/auth/v1/jwks  # (선택)
LOG_LEVEL=INFO
```

### 12.2 nginx 핵심 설정(접두사 제거 + 프록시)
```nginx
location /class/api/ {
    client_max_body_size 0;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    rewrite ^/class/api/(.*)$ /$1 break;   # 접두사 제거
    proxy_pass http://file-service:8000;   # 끝에 / 없음
}
```

### 12.3 docker-compose.override.yml(요지)
```yaml
services:
  file-service:
    build: ./services/file-service
    env_file: [./services/file-service/.env]
    volumes: [/mnt/nas-class:/mnt/nas-class:rw]
    restart: unless-stopped
    networks: [default]

  nginx:
    depends_on: [file-service]
    networks: [default, ollama-network]

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate --config /etc/cloudflared/config.yml run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    volumes: [./services/cloudflared/config.yml:/etc/cloudflared/config.yml:ro]
    depends_on: [nginx]
    networks: [default]

networks:
  ollama-network:
    external: true
    name: docker-services_ollama-network
```

### 12.4 cloudflared 설정(업로드 530 방지)
```yaml
# services/cloudflared/config.yml
ingress:
  - hostname: info.pocheonil.hs.kr
    service: http://nginx:80
    originRequest:
      disableChunkedEncoding: true
      http2Origin: false
      connectTimeout: 30s
      readTimeout: 600s
      writeTimeout: 600s
  - service: http_status:404
```

### 12.5 Supabase
- 스키마/RLS: 본 문서 4A 섹션 SQL 실행
- 관리자 롤 부여:
```sql
insert into public.roles(user_id, role)
select id, 'admin' from auth.users where email='menamiji@pocheonil.hs.kr'
on conflict (user_id) do update set role = excluded.role;
```
- 키 확인: Settings → API(anon/service_role), Settings → API → JWT Keys(Legacy JWT secret)

### 12.6 동작 점검(커맨드)
```bash
# 내부
curl -i http://127.0.0.1/class/api/healthz | head -10

# 외부(캐시 우회)
curl -i "https://info.pocheonil.hs.kr/class/api/healthz?t=$(date +%s)" | head -10

# 토큰 발급(임시 비밀번호 방식)
ANON_KEY=<anon>
ACCESS_TOKEN=$(curl -s "https://znocjtfrtxwulyngzqfy.supabase.co/auth/v1/token?grant_type=password" \
  -H "apikey: $ANON_KEY" -H "Content-Type: application/json" \
  -d '{"email":"menamiji@gmail.com","password":"asdf1234"}' | jq -r .access_token)
AUTH="Bearer $ACCESS_TOKEN"

# 업로드/목록/삭제
echo hello > ~/test.txt
curl -i -H "Authorization: $AUTH" -F 'files=@/home/menamiji/test.txt' \
  https://info.pocheonil.hs.kr/class/api/submissions/upload
TODAY=$(date +%Y%m%d)
curl -i -H "Authorization: $AUTH" \
  "https://info.pocheonil.hs.kr/class/api/submissions?date=$TODAY"
curl -i -H "Authorization: $AUTH" -X DELETE \
  "https://info.pocheonil.hs.kr/class/api/submissions/file?date_key=$TODAY&filename=test.txt"
rm -f ~/test.txt
```

### 12.7 주의/상태
- Cloudflare: Disable Chunked Encoding = ON 유지
- NAS 권한: 디렉터리 775, 파일 664, 소유자 menamiji:docker
- nginx↔file-service 동일 네트워크 연결 유지(default, 필요시 ollama-network 병행)

## 13. 다음 작업(권장 순서)
- Flutter 연동(프런트 소스)
  - supabase_flutter/http 추가, 초기화(define로 URL/ANON_KEY 주입)
  - 로그인(구글 권장) → `accessToken`으로 `/class/api` 호출
  - 업로드에서 `student_no` 파라미터 제거
- Compose 경고 제거
  - `sed -i '/^version:/d' ~/docker-services/docker-compose.yml && cd ~/docker-services && docker compose up -d`
- 모니터(선택)
  - `/usr/local/bin/class-api-check.sh`로 내부/외부 헬스 체크 후 syslog 기록, crontab 등록
